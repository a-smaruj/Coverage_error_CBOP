---
title: "R Notebook"
output: html_notebook
---

```{r}
library(RcppSimdJson)
library(data.table)
library("lubridate")
library(tidyverse)
```

```{r}
read_cbop <- function(file) {
  cbop_file <- readLines(file)
  cbop <- fparse(json = cbop_file[1])

  cbop_list <- list()
  for (i in 1:length(cbop)) {
    
      prac <- cbop[[i]]$danePracodawcy
      names(prac) <- cbop[[i]]$hash
      prac_df <-  rbindlist(prac, idcol = "hash")
      setnames(prac_df, names(prac_df)[-1], paste0("prac_", names(prac_df)[-1]))
      
      pozostaleDane <- rbindlist(cbop[[i]]$pozostaleDane)
      setnames(pozostaleDane, names(pozostaleDane), paste0("poz_", names(pozostaleDane)))
      
      warunkiPracyIPlacy <- rbindlist(cbop[[i]]$warunkiPracyIPlacy)
      setnames(warunkiPracyIPlacy, names(warunkiPracyIPlacy), 
               paste0("war_", names(warunkiPracyIPlacy)))
      
      prac_df <- cbind(prac_df, pozostaleDane, warunkiPracyIPlacy)
      
      prac_df[, ":="(typOferty = cbop[[i]]$typOferty,
                     czyWazna = cbop[[i]]$czyWazna,
                     statusOferty = cbop[[i]]$statusOferty)]
      cbop_list[[i]] <- prac_df
  }

  cbop_list_df <- rbindlist(cbop_list)
  cbop_list_df[, .SD, .SDcols = names(cbop_list_df) %like% "data|oferta"]
  cbop_list_df[, ":="(poz_dataPrzyjZglosz=dmy(poz_dataPrzyjZglosz),
                      poz_ofertaWaznaDo=dmy(poz_ofertaWaznaDo))]
  
  final_df <- cbop_list_df[  typOferty == "OFERTA_PRACY" & 
                             czyWazna == TRUE & 
                             war_kraj == "Polska" & 
                        (!is.na(prac_regon) | !is.na(prac_nip)) &
                          war_rodzajZatrudnienia %in% 
                              c("Umowa o pracę na czas określony",                                                        "Umowa o pracę na czas nieokreślony", 
                                "Umowa o pracę w zastępstwie", 
                                "Umowa o pracę na okres próbny",
                                "Umowa na czas wyk. określonej pracy")][
                          , ":="(prac_nip = str_remove_all(prac_nip, "-"),
                                 kod_pocztowy = str_extract(war_miejscePracy,
                                                            "\\d{2}\\-\\d{3}"))][
                            !prac_nip %in% c("0000000000", "1111111111")]

  final_df[, ":="(war_gmina = tolower(war_gmina), 
                  war_miejscowosc=tolower(war_miejscowosc))]
  final_df[, ":="(war_gmina = str_remove(war_gmina, "m.st. "))]
  final_df[, kod_pocztowy:=str_remove(kod_pocztowy, "00-000")]
  final_df[kod_pocztowy == "", kod_pocztowy := NA]
  final_df[, poz_kodZawodu := str_remove(poz_kodZawodu, "RPd057\\|")]

  return(final_df)
}
```

```{r}
#2020
cbop_2020 <- list()
files <- Sys.glob('data\\2020\\*.json')

for (file in files) {
    cbop_2020[[length(cbop_2020)+1]] <- read_cbop(file)
}

names(cbop_2020) <- basename(files)

cbop_2020 <- rbindlist(cbop_2020, idcol = "files")

#TODO - duplicates
cbop_2020 <- unique(cbop_2020)

#Useful columns
cbop_2020 <- cbop_2020 %>% select(hash, poz_identyfikatorOferty, poz_kodZawodu,
                                  poz_lWolnychMiejsc, poz_dataUdostepnieniaOferty,
                                  poz_dataPrzyjZglosz, poz_ofertaWaznaDo,
                                  poz_ofertaZgloszonaPrzez, 
                                  poz_ofertaZgloszonaPrzezKodJednostki, war_kraj,
                                  war_wojewodztwo, war_kodWojewodztwa, war_powiat,
                                  war_kodPowiatu, war_gmina, war_miejscowosc,
                                  war_kodMiejscowosci, war_miejscePracy, war_zawod,
                                  war_wymiarEtatu, war_rodzajZatrudnienia,
                                  war_kodRodzajuZatrudnienia, war_pensjaNetto, 
                                  prac_nazwaUrzeduPracy, statusOferty, kod_pocztowy)
```

```{r}
#2022
cbop_2022 <- list()
files <- Sys.glob('data\\2022\\*.json')

for (file in files) {
    cbop_2022[[length(cbop_2022)+1]] <- read_cbop(file)
}

names(cbop_2022) <- basename(files)

cbop_2022 <- rbindlist(cbop_2022, idcol = "files")

#TODO - duplicates
cbop_2022 <- unique(cbop_2022)

#Useful columns
cbop_2022 <- cbop_2022 %>% select(hash, poz_identyfikatorOferty, poz_kodZawodu,
                                  poz_lWolnychMiejsc, poz_dataUdostepnieniaOferty,
                                  poz_dataPrzyjZglosz, poz_ofertaWaznaDo,
                                  poz_ofertaZgloszonaPrzez, 
                                  poz_ofertaZgloszonaPrzezKodJednostki, war_kraj,
                                  war_wojewodztwo, war_kodWojewodztwa, war_powiat,
                                  war_kodPowiatu, war_gmina, war_miejscowosc,
                                  war_kodMiejscowosci, war_miejscePracy, war_zawod,
                                  war_wymiarEtatu, war_rodzajZatrudnienia,
                                  war_kodRodzajuZatrudnienia, war_pensjaNetto, 
                                  prac_nazwaUrzeduPracy, statusOferty, kod_pocztowy)
```

```{r}
#1 Part 2021
cbop_2021_1 <- list()

files <- Sys.glob('data\\2021\\*.json') 

files_1 <- files[1:floor(length(files)/2)]

for (file in files_1) {
    cbop_2021_1[[length(cbop_2021_1)+1]] <- read_cbop(file)
}

names(cbop_2021_1) <- basename(files_1)

cbop_2021_1 <- rbindlist(cbop_2021_1, idcol = "files_1")

#TODO - duplicates
cbop_2021_1 <- unique(cbop_2021_1)

#Useful columns
cbop_2021_1 <- cbop_2021_1 %>% select(hash, poz_identyfikatorOferty, poz_kodZawodu,
                                  poz_lWolnychMiejsc, poz_dataUdostepnieniaOferty,
                                  poz_dataPrzyjZglosz, poz_ofertaWaznaDo,
                                  poz_ofertaZgloszonaPrzez, 
                                  poz_ofertaZgloszonaPrzezKodJednostki, war_kraj,
                                  war_wojewodztwo, war_kodWojewodztwa, war_powiat,
                                  war_kodPowiatu, war_gmina, war_miejscowosc,
                                  war_kodMiejscowosci, war_miejscePracy, war_zawod,
                                  war_wymiarEtatu, war_rodzajZatrudnienia,
                                  war_kodRodzajuZatrudnienia, war_pensjaNetto, 
                                  prac_nazwaUrzeduPracy, statusOferty, kod_pocztowy)
```

```{r}
#2 Part 2021
cbop_2021_2 <- list()
files_2 <- files[(1+floor(length(files)/2)):length(files)]

for (file in files_2) {
    cbop_2021_2[[length(cbop_2021_2)+1]] <- read_cbop(file)
}

names(cbop_2021_2) <- basename(files_2)

cbop_2021_2 <- rbindlist(cbop_2021_2, idcol = "files_2")

#TODO - duplicates
cbop_2021_2 <- unique(cbop_2021_2)

#Useful columns
cbop_2021_2 <- cbop_2021_2 %>% select(hash, poz_identyfikatorOferty, poz_kodZawodu,
                                  poz_lWolnychMiejsc, poz_dataUdostepnieniaOferty,
                                  poz_dataPrzyjZglosz, poz_ofertaWaznaDo,
                                  poz_ofertaZgloszonaPrzez, 
                                  poz_ofertaZgloszonaPrzezKodJednostki, war_kraj,
                                  war_wojewodztwo, war_kodWojewodztwa, war_powiat,
                                  war_kodPowiatu, war_gmina, war_miejscowosc,
                                  war_kodMiejscowosci, war_miejscePracy, war_zawod,
                                  war_wymiarEtatu, war_rodzajZatrudnienia,
                                  war_kodRodzajuZatrudnienia, war_pensjaNetto, 
                                  prac_nazwaUrzeduPracy, statusOferty, kod_pocztowy)
```

```{r}
#2021 together
cbop_2021 <- rbindlist(list(cbop_2021_1, cbop_2021_2))
rm(cbop_2021_1)
rm(cbop_2021_2)

#TODO - duplicates
cbop_2021 <- unique(cbop_2021)
```

```{r}
#2020-2022 All
cbop_all <- rbindlist(list(cbop_2020, cbop_2021, cbop_2022))
#TODO - duplicates
cbop_all <- unique(cbop_all)
```

```{r}
#Create RDS file
saveRDS(cbop_2020, file = "cbop_2020.rds")
saveRDS(cbop_2021, file = "cbop_2021.rds")
saveRDS(cbop_2022, file = "cbop_2022.rds")
saveRDS(cbop_all, file = "cbop_all.rds")
```